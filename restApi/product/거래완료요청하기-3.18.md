# 거래완료 요청하기 API


### 거래완료 요청하기란

판매자가(즉, 물건을 올린 사람이) 판매하고자 하는 물건에 대해서 "거래완료"라는 행위를 통해
거래를 확정시키는 것을 의미한다.

그렇기 때문에 거래완료 요청을 할 수 있는 대상은 물건을 올린 판매자 밖에 없으며,
거래완료 요청하기 API를 할 수 있는 곳은 채팅방 밖에 없다.

거래완료는 두 번 요청할 수 없으며, 한 번 완료된 거래완료건에 대해서는 다시는 거래완료 전으로 돌아갈 수 없다.
그렇기 때문에 이미 한번 거래완료가 되면 취소불가능 하다라는 메시지를 현재 사용자에게 보여주고 있다.


**결론**

1. 거래완료는 채팅방에서 거래를 주고 받은 것을 전제로 한다. 그렇기 때문에 채팅방, 채팅방 목록에서만
거래완료를 할 수 있다.
   
2. 특정 상대방과 거래완료를 한 이후에는 거래완료를 한 사용자를 차단할 수 없다.

3. 거래완료는 물건을 업로드한 판매자만 할 수 있다.

4. 판매자가 거래완료를 하였을 경우에만 구매자는 구매후기를 작성할 수 있다. 구매후기를 쓸 수 있는 장소는 해당 유저와
나누었던 채팅방 그리고 내 거래정보 페이지에서의 구매물건 목록에서 작성할 수 있다.
   
5. 거래완료 요청을 할 수 없는 예외 상황이 있다.(아래의 예외 참고)
   
   
**예외**

거래완료는 아래와 같은 상황일 경우에는 거래완료 요청을 할 수 없다.
1. 거래완료를 하려고하는 상대방(구매자)이 탈퇴한경우
2. 거래완료를 하려고하는 상대방(구매자)이 관리자로부터 이용제재를 받고있는 경우
3. 내 물건(판매자가 올린 물건)이 삭제된 경우
4. 내 물건(판매자가 올린 물건)이 관리자로 부터 블라인드처리된 경우
5. 이미 거래완료되어 있는 경우
6. 나 또는 상대방 중 어느한명이라도 서로 차단을 걸고 있는 경우


--- 

**URL** : `/api/chatroom/{roomId}/trade-done`

**Request param(path)** : 
`roomId` : 채팅방번호

**Method** : `POST`

**Auth required** : YES



### request_body
`transaction_status_id` : 물건거래상태값 (거래완료(판매완료) 는 2 이다)


### response_body

`code` : `200 OK`

product status updated(string)


### 예외사항(response)

1. 거래완료를 하려고하는 상대방(구매자)이 탈퇴한경우

```json

{
  "statusCode": 400,
  "timestamp": "2021-03-18T05:42:46.242+00:00",
  "message": "존재하지 않는 유저와는 거래완료를 하실 수 없습니다.",
  "description": "uri=/api/chatroom/1/trade-done"
}

```


2. 거래완료를 하려고하는 상대방(구매자)이 관리자로부터 이용제재를 받고있는 경우
이 경우에는 아래의 응답값을 받았을 경우에 클라이언트는 이용제재를 받고 있을 경우에 나와야하는 UI를 띄워줘야 한다.

```json

{
  "statusCode": 404,
  "timestamp": "2021-03-18T05:42:46.242+00:00",
  "message": "관리자로부터 제재를 받고있는 유저와는 거래완료를 하실 수 없습니다.",
  "description": "uri=/api/chatroom/1/trade-done"
}

```


3. 내 물건(판매자가 올린 물건)이 삭제된 경우
이 경우애는 물건만 삭제된 것 이기 때문에 채팅방 상단의 물건 영역에 있는 이미지를 기본이미지로 바꾸고
물건 설명역시 클라이언트에 보이지 않도록 해야한다.


```json
{
  "statusCode": 404,
  "timestamp": "2021-03-18T05:42:46.242+00:00",
  "message": "물건이 존재하지 않습니다.",
  "description": "uri=/api/chatroom/1/trade-done"
}

```


4. 내 물건(판매자가 올린 물건)이 관리자로 부터 블라인드처리된 경우
이 경우애는 물건만 블라인드처리 된 것이기 때문에 채팅방 상단의 물건 영역에 있는 이미지를 기본이미지로 바꾸고
물건 설명역시 클라이언트에 보이지 않도록 해야한다. 화면딴에 처리하는 방식은 3번과 같

```json

{
  "statusCode": 400,
  "timestamp": "2021-03-18T05:42:46.242+00:00",
  "message": "관리자에 의해 블라인드 처리된 물건입니다. 거래완료를 하실 수 없습니다.",
  "description": "uri=/api/chatroom/1/trade-done"
}

```


5. 이미 거래완료되어 있는 경우

일반적인 상황에서는 이런 경우는 없다. 하지만 한 명의 유저가 각기 다른 브라우저에 접속한 후
가령, 크롬과 파이어폭스 두개의 브라우저로 각각 로그인 후 동일한 채팅방에 들어간 상황일 때
만약 크롬브라우저에서 먼저 거래완료를 했다고 가정하자. 그러면 파이어폭스에 있는 채팅방 상태는 이전과 같은 거래완료가 되었을 때
나타나는 유아이 상황이 아닐 것이다. 이때 이미 크롬에서 거래완료를 했음에도 불구하고 또 다시 거래완료를 할 수 있는 상황이 만들어지기 때문에
아래와 같은 방식으로 예외처리를 했다.

클라이언트는 아래와같은 에러를 만난다면 먼저 거래완료 버튼을 비활성화 해야한다.(즉 거래완료를 클릭했던 상태와 똑같은 UI 상태)


```json

{
  "statusCode": 400,
  "timestamp": "2021-03-04T07:04:14.410+00:00",
  "message": "이미 거래완료 되어 있는 상태입니다.",
  "description": "uri=/api/chatroom/422/trade-done"
}
```



6. 나 또는 상대방 중 어느한명이라도 서로 차단을 걸고 있는 경우
내가 상대방을 차단하거나 상대방이 나를 차단하거나 혹은 서로 차단했을 경우 아래와 같은 예외 응답값을 반환한다.
   
아래의 경우에는 클라이언트는 차단관련 유아이형태로 바꿔야 한다.(이미 차단관련 유아이는 만들어 놓은 상태이기 때문에 해당 유아이를 활용하면 된다.)

```json

{
  "statusCode": 403,
  "timestamp": "2021-03-04T07:01:45.485+00:00",
  "message": "차단된 유저와는 거래완료를 할 수 없습니다.",
  "description": "uri=/api/chatroom/422/trade-done"
}

```

